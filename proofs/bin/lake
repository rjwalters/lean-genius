#!/bin/bash
# proofs/bin/lake - Safety wrapper that intercepts dangerous lake commands
#
# This script is placed earlier in PATH than ~/.elan/bin/lake to intercept
# calls and redirect to safe Docker-based builds.
#
# WHY THIS EXISTS:
# Lean tactics like 'grind' can consume 100GB+ memory in seconds, crashing
# the host system before any monitoring can react. Docker provides hard
# memory limits via cgroups that prevent this.
#
# SAFE COMMANDS (passed through):
#   lake env, lake clean, lake update, lake --version
#
# BLOCKED COMMANDS (use Docker wrapper):
#   lake build -> ./proofs/scripts/docker-build.sh
#
# BYPASS (use with extreme caution):
#   LAKE_UNSAFE=1 lake build ...

set -euo pipefail

# Colors for terminal output
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
BOLD='\033[1m'
NC='\033[0m'

# Find the real lake binary (skip this wrapper)
find_real_lake() {
    local script_dir
    script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

    # Check PATH for other lake binaries
    while IFS= read -r candidate; do
        if [[ "$candidate" != "$script_dir/lake" ]]; then
            echo "$candidate"
            return 0
        fi
    done < <(which -a lake 2>/dev/null || true)

    # Fallback to elan default
    if [[ -x "$HOME/.elan/bin/lake" ]]; then
        echo "$HOME/.elan/bin/lake"
        return 0
    fi
    return 1
}

# Get project root (where proofs/ directory is)
get_project_root() {
    local dir
    dir="$(pwd)"
    while [[ "$dir" != "/" ]]; do
        if [[ -d "$dir/proofs" && -f "$dir/proofs/lakefile.toml" ]]; then
            echo "$dir"
            return 0
        fi
        dir="$(dirname "$dir")"
    done
    # Fallback: assume we're in proofs/ or project root
    if [[ -f "$(pwd)/lakefile.toml" ]]; then
        dirname "$(pwd)"
    else
        pwd
    fi
}

print_blocked_message() {
    echo ""
    echo -e "${RED}${BOLD}+======================================================================+${NC}"
    echo -e "${RED}${BOLD}|  BLOCKED: Direct 'lake build' can crash your system                 |${NC}"
    echo -e "${RED}${BOLD}|                                                                      |${NC}"
    echo -e "${RED}${BOLD}|  Lean tactics like 'grind' can consume 100GB+ memory in seconds,    |${NC}"
    echo -e "${RED}${BOLD}|  faster than any monitoring can react. Docker enforces hard limits. |${NC}"
    echo -e "${RED}${BOLD}+======================================================================+${NC}"
    echo ""
}

print_safe_alternative() {
    local target="${1:-}"
    local project_root
    project_root="$(get_project_root 2>/dev/null || echo '.')"

    echo -e "${YELLOW}${BOLD}Safe alternative:${NC}"
    echo ""

    if [[ -n "$target" ]]; then
        echo -e "  ${GREEN}./proofs/scripts/docker-build.sh ${target}${NC}"
    else
        echo -e "  ${GREEN}./proofs/scripts/docker-build.sh                      ${NC}# Build all"
        echo -e "  ${GREEN}./proofs/scripts/docker-build.sh Proofs.YourProof     ${NC}# Specific target"
    fi

    echo ""
    echo -e "${YELLOW}Options:${NC}"
    echo "  LEAN_MEMORY_LIMIT=8192  ./proofs/scripts/docker-build.sh   # 8GB limit (default: 32GB)"
    echo "  LEAN_BUILD_TIMEOUT=30m  ./proofs/scripts/docker-build.sh   # 30min timeout"
    echo ""
    echo -e "${YELLOW}To bypass this safety check (DANGEROUS - may crash system):${NC}"
    echo "  LAKE_UNSAFE=1 lake build ${target}"
    echo ""
}

# Main logic
main() {
    local cmd="${1:-}"

    # Check for bypass flag (for advanced users who know the risks)
    if [[ "${LAKE_UNSAFE:-}" == "1" ]]; then
        local real_lake
        if real_lake="$(find_real_lake)"; then
            exec "$real_lake" "$@"
        else
            echo "Error: Could not find real lake binary" >&2
            exit 1
        fi
    fi

    case "$cmd" in
        build)
            # BLOCKED: This is the dangerous command
            print_blocked_message
            print_safe_alternative "${2:-}"
            exit 1
            ;;

        exe|env|clean|update|--version|-v|--help|-h|resolve-deps|script)
            # ALLOWED: These are safe commands
            local real_lake
            if real_lake="$(find_real_lake)"; then
                exec "$real_lake" "$@"
            else
                echo "Error: Could not find real lake binary" >&2
                exit 1
            fi
            ;;

        "")
            # No command - show help
            print_blocked_message
            echo -e "${YELLOW}This is a safety wrapper for the lean-genius project.${NC}"
            echo ""
            echo "Allowed commands (passed through to real lake):"
            echo "  lake env          # Print environment info"
            echo "  lake clean        # Clean build artifacts"
            echo "  lake update       # Update dependencies"
            echo "  lake --version    # Show version"
            echo ""
            echo "Blocked commands (use Docker wrapper instead):"
            echo "  lake build        # Use ./proofs/scripts/docker-build.sh"
            echo ""
            exit 0
            ;;

        *)
            # Unknown command - block with warning
            echo -e "${YELLOW}Warning: Unknown lake command '$cmd'${NC}"
            echo ""
            echo "If this is a safe command, you can bypass with:"
            echo "  LAKE_UNSAFE=1 lake $*"
            echo ""
            exit 1
            ;;
    esac
}

main "$@"
