/-!
# Erdős Problem #335: Density Additivity Characterization

Characterize those A, B ⊆ ℕ with positive density such that
d(A + B) = d(A) + d(B).

## Key Context

- Usually d(A + B) ≥ min(d(A) + d(B), 1) (Plünnecke–Ruzsa bounds)
- Exact additivity d(A + B) = d(A) + d(B) is a strong structural condition
- Known examples: fractional part sets {n : {nθ} ∈ X} for irrational θ
- Open: do all such pairs arise from group rotation constructions?

## References

- [ErGr80] Erdős–Graham (1980), p. 51
- <https://erdosproblems.com/335>
-/

import Mathlib.Data.Real.Basic
import Mathlib.Order.Filter.Basic
import Mathlib.Data.Set.Card
import Mathlib.Tactic

open Set Filter

/-! ## Density Definitions -/

/-- The counting function: |A ∩ {1,...,N}|. -/
noncomputable def countingFn (A : Set ℕ) (N : ℕ) : ℕ :=
  Set.ncard (A ∩ Set.Icc 1 N)

/-- The asymptotic density of A ⊆ ℕ: lim_{N→∞} |A ∩ [1,N]| / N. -/
noncomputable def asympDensity (A : Set ℕ) : ℝ :=
  Filter.limUnder atTop (fun N => (countingFn A N : ℝ) / N)

/-- The density exists (the limit converges). -/
def DensityExists (A : Set ℕ) : Prop :=
  ∃ d : ℝ, Filter.Tendsto (fun N => (countingFn A N : ℝ) / N) atTop (nhds d)

/-- A set has positive density. -/
def HasPositiveDensity (A : Set ℕ) : Prop :=
  0 < asympDensity A

/-! ## Sumset and Density Additivity -/

/-- The sumset A + B = {a + b : a ∈ A, b ∈ B}. -/
def Sumset (A B : Set ℕ) : Set ℕ :=
  {n | ∃ a ∈ A, ∃ b ∈ B, n = a + b}

/-- The key property: d(A + B) = d(A) + d(B).
    This is a strong structural constraint, much more restrictive than
    the general Plünnecke–Ruzsa inequality d(A + B) ≥ min(d(A) + d(B), 1). -/
def DensityAdditive (A B : Set ℕ) : Prop :=
  DensityExists A ∧ DensityExists B ∧ DensityExists (Sumset A B) ∧
  asympDensity (Sumset A B) = asympDensity A + asympDensity B

/-! ## Known Construction: Fractional Parts -/

/-- Fractional part function. -/
noncomputable def frac (x : ℝ) : ℝ := x - ⌊x⌋

/-- Sets constructed via fractional parts of nθ:
    A = {n > 0 : {nθ} ∈ X} for a measurable X ⊆ [0,1). -/
def FractionalPartSet (θ : ℝ) (X : Set ℝ) : Set ℕ :=
  {n | n > 0 ∧ frac (n * θ) ∈ X}

/-- For irrational θ, the density of FractionalPartSet θ X equals μ(X)
    by Weyl's equidistribution theorem. -/
axiom weyl_equidistribution (θ : ℝ) (X : Set ℝ) (hirrational : Irrational θ) :
  DensityExists (FractionalPartSet θ X)

/-- The known construction: if X_A and X_B have additive measure on ℝ/ℤ
    (μ(X_A + X_B) = μ(X_A) + μ(X_B)), then the corresponding fractional
    part sets have additive density. -/
axiom fractional_part_density_additive (θ : ℝ) (X_A X_B : Set ℝ)
    (hirrational : Irrational θ) :
  DensityAdditive (FractionalPartSet θ X_A) (FractionalPartSet θ X_B)

/-! ## Main Conjecture -/

/-- **Erdős Problem #335** (OPEN): Are all density-additive pairs
    generated by group rotation constructions?

    Formally: if A, B ⊆ ℕ have positive density and d(A+B) = d(A) + d(B),
    must there exist a compact abelian group G, a group element g,
    and measurable sets X_A, X_B ⊆ G such that A and B are obtained
    from the orbit of g through X_A and X_B? -/
axiom erdos_335_conjecture :
  ∀ A B : Set ℕ,
    HasPositiveDensity A → HasPositiveDensity B →
    DensityAdditive A B →
    ∃ (θ : ℝ) (X_A X_B : Set ℝ),
      Irrational θ ∧
      A = FractionalPartSet θ X_A ∧ B = FractionalPartSet θ X_B

/-! ## Basic Properties -/

/-- Density is non-negative. -/
axiom density_nonneg (A : Set ℕ) : asympDensity A ≥ 0

/-- Density is at most 1. -/
axiom density_le_one (A : Set ℕ) (hA : DensityExists A) : asympDensity A ≤ 1

/-- If d(A + B) = d(A) + d(B), then d(A) + d(B) ≤ 1.
    Otherwise the sumset would have density > 1, a contradiction. -/
axiom additive_sum_le_one (A B : Set ℕ) :
  DensityAdditive A B → asympDensity A + asympDensity B ≤ 1

/-- **Plünnecke–Ruzsa lower bound** (simplified):
    d(A + B) ≥ min(d(A) + d(B), 1) for sets with density. -/
axiom plunnecke_ruzsa_lower (A B : Set ℕ)
    (hA : DensityExists A) (hB : DensityExists B)
    (hAB : DensityExists (Sumset A B)) :
  asympDensity (Sumset A B) ≥ min (asympDensity A + asympDensity B) 1

/-- Density additivity implies the Plünnecke–Ruzsa bound is tight. -/
theorem additive_implies_tight (A B : Set ℕ) (h : DensityAdditive A B) :
    asympDensity (Sumset A B) = min (asympDensity A + asympDensity B) 1 := by
  obtain ⟨_, _, _, heq⟩ := h
  have hle := additive_sum_le_one A B h
  rw [heq, min_eq_left hle]
